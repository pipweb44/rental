{% extends 'base.html' %}

{% block title %}تغيير كلمة المرور - العقارات الفاخرة{% endblock %}

{% block content %}
<!-- Luxury Page Header -->
<section class="luxury-page-header">
    <div class="header-background"></div>
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="page-title-content" data-aos="fade-right">
                    <h1 class="page-title">
                        <i class="fas fa-lock me-3"></i>
                        تغيير كلمة المرور
                    </h1>
                    <p class="page-subtitle">
                        حدث كلمة المرور الخاصة بك لحماية حسابك
                    </p>
                    <div class="breadcrumb-luxury">
                        <a href="{% url 'properties:home' %}">الرئيسية</a>
                        <i class="fas fa-chevron-left"></i>
                        <a href="{% url 'users:profile' %}">الملف الشخصي</a>
                        <i class="fas fa-chevron-left"></i>
                        <span>تغيير كلمة المرور</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-end">
                <div class="header-actions" data-aos="fade-left">
                    <a href="{% url 'users:profile' %}" class="luxury-btn luxury-btn-outline">
                        <i class="fas fa-arrow-right me-2"></i>
                        العودة للملف الشخصي
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- Change Password Form -->
            <div class="luxury-password-card" data-aos="fade-up">
                <div class="form-header">
                    <div class="header-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>تغيير كلمة المرور</h3>
                    <p>أدخل كلمة المرور الحالية والجديدة لتحديث حسابك</p>
                </div>

                <form method="post" class="luxury-password-form">
                    {% csrf_token %}
                    
                    <!-- Current Password -->
                    <div class="form-group mb-4">
                        <label class="luxury-form-label">
                            <i class="fas fa-lock me-2"></i>
                            كلمة المرور الحالية *
                        </label>
                        <div class="password-input-wrapper">
                            {{ form.old_password }}
                            <button type="button" class="password-toggle" onclick="togglePassword('id_old_password', 'oldPasswordIcon')">
                                <i class="fas fa-eye" id="oldPasswordIcon"></i>
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                            <div class="error-message">
                                {% for error in form.old_password.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- New Password -->
                    <div class="form-group mb-4">
                        <label class="luxury-form-label">
                            <i class="fas fa-key me-2"></i>
                            كلمة المرور الجديدة *
                        </label>
                        <div class="password-input-wrapper">
                            {{ form.new_password1 }}
                            <button type="button" class="password-toggle" onclick="togglePassword('id_new_password1', 'newPassword1Icon')">
                                <i class="fas fa-eye" id="newPassword1Icon"></i>
                            </button>
                        </div>
                        {% if form.new_password1.errors %}
                            <div class="error-message">
                                {% for error in form.new_password1.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Password Strength Indicator -->
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="strengthFill"></div>
                            </div>
                            <div class="strength-text" id="strengthText">قوة كلمة المرور</div>
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div class="form-group mb-4">
                        <label class="luxury-form-label">
                            <i class="fas fa-check-circle me-2"></i>
                            تأكيد كلمة المرور الجديدة *
                        </label>
                        <div class="password-input-wrapper">
                            {{ form.new_password2 }}
                            <button type="button" class="password-toggle" onclick="togglePassword('id_new_password2', 'newPassword2Icon')">
                                <i class="fas fa-eye" id="newPassword2Icon"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                            <div class="error-message">
                                {% for error in form.new_password2.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Password Match Indicator -->
                        <div class="password-match" id="passwordMatch" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span>كلمات المرور متطابقة</span>
                        </div>
                    </div>

                    <!-- Password Requirements -->
                    <div class="password-requirements">
                        <h6>متطلبات كلمة المرور:</h6>
                        <ul class="requirements-list">
                            <li class="requirement" data-requirement="length">
                                <i class="fas fa-times"></i>
                                <span>8 أحرف على الأقل</span>
                            </li>
                            <li class="requirement" data-requirement="uppercase">
                                <i class="fas fa-times"></i>
                                <span>حرف كبير واحد على الأقل</span>
                            </li>
                            <li class="requirement" data-requirement="lowercase">
                                <i class="fas fa-times"></i>
                                <span>حرف صغير واحد على الأقل</span>
                            </li>
                            <li class="requirement" data-requirement="number">
                                <i class="fas fa-times"></i>
                                <span>رقم واحد على الأقل</span>
                            </li>
                            <li class="requirement" data-requirement="special">
                                <i class="fas fa-times"></i>
                                <span>رمز خاص واحد على الأقل</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="submit" class="luxury-btn luxury-btn-primary luxury-btn-lg w-100 mb-3">
                            <i class="fas fa-save me-2"></i>
                            تحديث كلمة المرور
                        </button>
                        <a href="{% url 'users:profile' %}" class="luxury-btn luxury-btn-outline luxury-btn-lg w-100">
                            <i class="fas fa-times me-2"></i>
                            إلغاء
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Security Tips Card -->
            <div class="security-tips-card luxury-card sticky-top" data-aos="fade-left" style="top: 120px;">
                <div class="tips-header">
                    <h5>
                        <i class="fas fa-shield-alt me-2"></i>
                        نصائح الأمان
                    </h5>
                </div>
                <div class="tips-body">
                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="tip-content">
                            <h6>كلمة مرور قوية</h6>
                            <p>استخدم مزيج من الأحرف والأرقام والرموز</p>
                        </div>
                    </div>
                    
                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <div class="tip-content">
                            <h6>لا تشارك كلمة المرور</h6>
                            <p>احتفظ بكلمة المرور سرية ولا تشاركها مع أحد</p>
                        </div>
                    </div>
                    
                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="tip-content">
                            <h6>غير كلمة المرور دورياً</h6>
                            <p>ننصح بتغيير كلمة المرور كل 3-6 أشهر</p>
                        </div>
                    </div>
                    
                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="tip-content">
                            <h6>تفعيل التحقق بخطوتين</h6>
                            <p>أضف طبقة حماية إضافية لحسابك</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Security Status -->
            <div class="security-status-card luxury-card mt-4" data-aos="fade-left" data-aos-delay="200">
                <div class="status-header">
                    <h6>حالة أمان الحساب</h6>
                </div>
                <div class="status-body">
                    <div class="security-score">
                        <div class="score-circle">
                            <div class="score-text">85%</div>
                        </div>
                        <div class="score-label">نقاط الأمان</div>
                    </div>
                    
                    <div class="security-items">
                        <div class="security-item verified">
                            <i class="fas fa-check-circle"></i>
                            <span>البريد الإلكتروني محقق</span>
                        </div>
                        <div class="security-item pending">
                            <i class="fas fa-clock"></i>
                            <span>رقم الهاتف غير محقق</span>
                        </div>
                        <div class="security-item verified">
                            <i class="fas fa-lock"></i>
                            <span>كلمة مرور قوية</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Password Card */
.luxury-password-card {
    background: var(--luxury-white);
    border-radius: 25px;
    box-shadow: var(--luxury-shadow-heavy);
    overflow: hidden;
    border-top: 4px solid var(--luxury-gold);
}

.form-header {
    background: linear-gradient(135deg, var(--luxury-pearl) 0%, var(--luxury-white) 100%);
    padding: 3rem 2rem;
    text-align: center;
    border-bottom: 1px solid var(--luxury-light-gray);
}

.header-icon {
    width: 80px;
    height: 80px;
    background: var(--luxury-gradient-gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 2rem;
    font-size: 2rem;
    color: white;
    box-shadow: var(--luxury-shadow-gold);
}

.form-header h3 {
    font-family: var(--luxury-font-secondary);
    font-size: 2rem;
    color: var(--luxury-charcoal);
    margin-bottom: 1rem;
    font-weight: 700;
}

.form-header p {
    color: var(--luxury-gray);
    font-size: 1.1rem;
    margin: 0;
}

.luxury-password-form {
    padding: 2rem;
}

/* Password Input */
.password-input-wrapper {
    position: relative;
}

.password-input-wrapper input {
    padding-left: 3rem;
}

.password-toggle {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--luxury-gray);
    cursor: pointer;
    transition: var(--luxury-transition);
    z-index: 2;
}

.password-toggle:hover {
    color: var(--luxury-gold);
}

/* Password Strength */
.password-strength {
    margin-top: 1rem;
}

.strength-bar {
    width: 100%;
    height: 8px;
    background: var(--luxury-light-gray);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.strength-fill {
    height: 100%;
    width: 0%;
    transition: var(--luxury-transition);
    border-radius: 4px;
}

.strength-text {
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
}

.strength-weak .strength-fill {
    width: 25%;
    background: var(--luxury-burgundy);
}

.strength-weak .strength-text {
    color: var(--luxury-burgundy);
}

.strength-fair .strength-fill {
    width: 50%;
    background: #FFA500;
}

.strength-fair .strength-text {
    color: #FFA500;
}

.strength-good .strength-fill {
    width: 75%;
    background: #4CAF50;
}

.strength-good .strength-text {
    color: #4CAF50;
}

.strength-strong .strength-fill {
    width: 100%;
    background: var(--luxury-emerald);
}

.strength-strong .strength-text {
    color: var(--luxury-emerald);
}

/* Password Match */
.password-match {
    margin-top: 1rem;
    color: var(--luxury-emerald);
    font-size: 0.9rem;
    font-weight: 600;
}

.password-match i {
    margin-left: 0.5rem;
}

/* Password Requirements */
.password-requirements {
    background: var(--luxury-pearl);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.password-requirements h6 {
    color: var(--luxury-charcoal);
    margin-bottom: 1.5rem;
    font-weight: 600;
    text-align: center;
}

.requirements-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

.requirement {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
    transition: var(--luxury-transition);
}

.requirement i {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: var(--luxury-burgundy);
    background: rgba(139, 0, 0, 0.1);
    flex-shrink: 0;
}

.requirement.valid i {
    color: var(--luxury-emerald);
    background: rgba(80, 200, 120, 0.1);
}

.requirement.valid {
    color: var(--luxury-emerald);
}

/* Security Tips Card */
.security-tips-card {
    padding: 0;
    overflow: hidden;
}

.tips-header {
    background: var(--luxury-gradient-gold);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.tips-header h5 {
    margin: 0;
    font-weight: 600;
}

.tips-body {
    padding: 2rem;
}

.tip-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 2rem;
}

.tip-item:last-child {
    margin-bottom: 0;
}

.tip-icon {
    width: 50px;
    height: 50px;
    background: var(--luxury-gradient-gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.tip-content h6 {
    margin: 0 0 0.5rem 0;
    color: var(--luxury-charcoal);
    font-weight: 600;
    font-size: 1rem;
}

.tip-content p {
    margin: 0;
    color: var(--luxury-gray);
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Security Status Card */
.security-status-card {
    padding: 0;
    overflow: hidden;
}

.status-header {
    background: var(--luxury-pearl);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--luxury-light-gray);
}

.status-header h6 {
    margin: 0;
    color: var(--luxury-charcoal);
    font-weight: 600;
}

.status-body {
    padding: 2rem;
}

.security-score {
    text-align: center;
    margin-bottom: 2rem;
}

.score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(var(--luxury-gold) 0deg 306deg, var(--luxury-light-gray) 306deg 360deg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    position: relative;
}

.score-circle::before {
    content: '';
    width: 60px;
    height: 60px;
    background: var(--luxury-white);
    border-radius: 50%;
    position: absolute;
}

.score-text {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--luxury-gold);
    z-index: 1;
    font-family: var(--luxury-font-secondary);
}

.score-label {
    color: var(--luxury-gray);
    font-weight: 600;
}

.security-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.security-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
}

.security-item.verified i {
    color: var(--luxury-emerald);
}

.security-item.pending i {
    color: var(--luxury-gray);
}

/* Responsive */
@media (max-width: 768px) {
    .form-header {
        padding: 2rem 1.5rem;
    }
    
    .form-header h3 {
        font-size: 1.5rem;
    }
    
    .luxury-password-form {
        padding: 1.5rem;
    }
    
    .requirements-list {
        grid-template-columns: 1fr;
    }
    
    .tip-item {
        flex-direction: column;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Password toggle functions
function togglePassword(inputId, iconId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = document.getElementById(iconId);
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    let score = 0;
    let feedback = '';
    
    // Length check
    if (password.length >= 8) score += 1;
    
    // Uppercase check
    if (/[A-Z]/.test(password)) score += 1;
    
    // Lowercase check
    if (/[a-z]/.test(password)) score += 1;
    
    // Number check
    if (/[0-9]/.test(password)) score += 1;
    
    // Special character check
    if (/[^A-Za-z0-9]/.test(password)) score += 1;
    
    const strengthIndicator = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');
    
    // Remove all strength classes
    strengthIndicator.classList.remove('strength-weak', 'strength-fair', 'strength-good', 'strength-strong');
    
    if (score <= 2) {
        strengthIndicator.classList.add('strength-weak');
        strengthText.textContent = 'ضعيفة';
    } else if (score === 3) {
        strengthIndicator.classList.add('strength-fair');
        strengthText.textContent = 'متوسطة';
    } else if (score === 4) {
        strengthIndicator.classList.add('strength-good');
        strengthText.textContent = 'جيدة';
    } else if (score === 5) {
        strengthIndicator.classList.add('strength-strong');
        strengthText.textContent = 'قوية جداً';
    }
    
    return score;
}

// Password requirements validation
function validatePasswordRequirements(password) {
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^A-Za-z0-9]/.test(password)
    };
    
    Object.keys(requirements).forEach(req => {
        const element = document.querySelector(`[data-requirement="${req}"]`);
        if (requirements[req]) {
            element.classList.add('valid');
            element.querySelector('i').className = 'fas fa-check';
        } else {
            element.classList.remove('valid');
            element.querySelector('i').className = 'fas fa-times';
        }
    });
}

// Password match checker
function checkPasswordMatch() {
    const password1 = document.getElementById('id_new_password1').value;
    const password2 = document.getElementById('id_new_password2').value;
    const matchIndicator = document.getElementById('passwordMatch');
    
    if (password2.length > 0) {
        if (password1 === password2) {
            matchIndicator.style.display = 'block';
            matchIndicator.style.color = 'var(--luxury-emerald)';
            matchIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>كلمات المرور متطابقة</span>';
        } else {
            matchIndicator.style.display = 'block';
            matchIndicator.style.color = 'var(--luxury-burgundy)';
            matchIndicator.innerHTML = '<i class="fas fa-times-circle"></i><span>كلمات المرور غير متطابقة</span>';
        }
    } else {
        matchIndicator.style.display = 'none';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.getElementById('id_new_password1');
    const newPassword2 = document.getElementById('id_new_password2');
    
    if (newPassword1) {
        newPassword1.addEventListener('input', function() {
            const password = this.value;
            checkPasswordStrength(password);
            validatePasswordRequirements(password);
            checkPasswordMatch();
        });
    }
    
    if (newPassword2) {
        newPassword2.addEventListener('input', checkPasswordMatch);
    }
    
    // Form submission
    const form = document.querySelector('.luxury-password-form');
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري التحديث...';
        submitBtn.disabled = true;
        
        // Re-enable after a delay (in case of validation errors)
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 3000);
    });
});
</script>
{% endblock %}
